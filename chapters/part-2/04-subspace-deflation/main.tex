\chapter{Subspace deflation}
\label{ch:p2:subspace-deflation}

\readit{4}

% \worktodo{
% * Subspace deflation (2 lvl, loop, hat notation)
%   * Lattice
%   * R and T (non-square ops)
%   * Subspace ops defined as hatA = R A T (square iff A square)
%   * Inverse (prop) decomposition (Ainv decomp)
%   * Solver preconditioning, A x=b: L A x = L b with L = T hatAinv R
%   * 2pt correlator decomp maybe
%   * lma
%     * eg: 2pt corr estimator -> its prop decomp, [Q,P]=0 <=> phi = modes of Q
%     * extensions to LMA
%       * AMA with its prop decomp
%     * problems -> volume scaling, expensive modes, memory, ...
%       * X-term problem
%       * V2 problem
% }

\tldr{subspace deflation intro}
The method of low-mode averaging from the last chapter will be generalized to cover not only subspaces spanned by low modes but arbitrary subspaces spanned by an arbitrary set of (currently unspecified) orthonormal basis fields (\cref{sec:sd:def}).
We will discuss general operators acting on the lattice and how to restrict them to the subspaces -- a process which we will call coarsening (\cref{sec:sd:coarse:ops}).
Revisiting LMA shows that it is a special case of subspace deflation (\cref{sec:sd:lma}), before we close the chapter with a summary (\cref{sec:sd:summary}).
% For this, we need to define the degrees of freedom on a spacetime lattice.



% \section{Lattice definition}
% \label{sec:lattice:definition}

% \tldr{lattice definition}
% We define a \df{lattice} $\lattice$ as the set of its indices.
% The fine-grid lattice is defined as the triple $\lattice = (\idxspacetime, \idxspin, \idxcolor)$ and its index set is the cross-product $\idxset = \idxspacetime \times \idxspin \times \idxcolor$ with
% \begin{align}
% \begin{aligned}
% \text{the spacetime lattice }
%     \idxspacetime &= \idxtime \times \idxspace, \\
% \text{the temporal lattice }
%     \idxtime  &= \exptime, \\
% \text{the spatial lattice }
%     \idxspace &= \expspace, \\
% \text{the spins }
%     \idxspin  &= \expspin, \\
% \text{the colors }
%     \idxcolor &= \expcolor,
% \end{aligned} \label{eq:index:sets}
% \end{align}
% where $\Lt,L_i,\cNs,\cNc \in \mathbb{N}$.
% The product $V = \Lt \Lx \Ly \Lz$ is called the \df{lattice volume}, whereas the product $\cNs \cNc$ parametrize the internal degrees of freedom of a spinor field on each lattice point.
% The product of the two $d = V \cNs \cNc$ gives us the dimension over the complex numbers $\mathbb{C}$ of spinor fields and operators acting on spinor fields on the lattice.
% The native lattice where $(\cNs, \cNc) = (4,3)$, we will call the \df{fine-grid lattice} $\lattice$.
% Furthermore, the Hilbert space of spinor fields $\vslattice$ is the tensor product of Hilbert spaces,
% \begin{equation}
% \vslattice = \mathcal{H}_{L_0} \otimes \mathcal{H}_{L_1} \otimes \mathcal{H}_{L_2} \otimes \mathcal{H}_{L_3} \otimes \mathcal{H}_{\Ns} \otimes \mathcal{H}_{\Nc} \cong \mathbb{C}^{d} \;,
% \end{equation}
% where each individual space corresponds to an index set in \cref{eq:index:sets} and is isomorphic to $\mathcal{H}_{N} \cong \mathbb{C}^{N}$.
% We note, the Dirac operator which is an endomorphism on this Hilbert space, $D \colon \vslattice \rightarrow \vslattice$, is not separable into a tensor product, because its action to a spinor field couples and mixes all individual degrees of freedom non-trivially, compare \cref{eq:Dw:QCD+QED}.

\section{Subspace definition}
\label{sec:sd:def}

\tldr{arbitrary ONB}
We want to formalize and generalize the idea of low-mode averaging from the previous chapter to an arbitrary orthonormal basis of $N$ spinor fields $\phi_{i} \in \mathcal{B}$ spanning an arbitrary subspace $\vspan{\mathcal{B}} \subseteq \vslattice$ of the fine-grid lattice Hilbert space $\vslattice = \mathbb{C}^d$.
%The vector space of spinor fields spanned by the fine-grid lattice $\lattice = \mathbb{C}^d$ will be denoted by $\vslattice$, implying $\text{span}(\mathcal{B}) \subseteq \vslattice$.
The space $\vspan{\mathcal{B}}$ is isomorphic to a Hilbert space $\coarse{\vslattice}$ of dimension $N$.
In accordance to \cref{sec:lattice:definition}, for now we define the dimension over the complex numbers of the subspace as $\coarse{d} = \dim_{\mathbb{C}}(\coarse{\vslattice})$, whereas the dimension of the fine space $\vslattice$ is $d = \dim_{\mathbb{C}}(\vslattice)$.
The choice of the basis fields and its implications will be discussed later.

\tldr{restrictor definition}
We define two non-square matrices that act as inter-grid operators between the vector spaces $\vslattice$ and $\coarse{\vslattice}$.
One which we call the \df{restrictor} $\restrictor$ restricts a spinor $\psi$ to the subspace and acts as
\begin{align}
&\begin{aligned}
\restrictor \colon
\vslattice &\longrightarrow \coarse{\vslattice} \;, \\
\psi       &\longmapsto     \coarse{\psi} \;, \\
(R \psi)_{[i]} &= \sprod{\phi_{i}}{\psi} \;,
& i &\in \{ 0, \ldots, N-1 \} \;,
\end{aligned} \label{eq:R}
\end{align}
where the subscript notation $\psi_{[i]}$ indicates the $i$-th component of the vector $\psi$ (see \cref{sec:notation:index}) and the scalar product goes over all indices of spinors; color, spin and spacetime.

\tldr{prolongator definition}
The second, which we call the \df{prolongator} $\prolongator$, prolongs information back from the subspace to the vector space of spinors.
It acts as
\begin{align}
&\begin{aligned}
\prolongator \colon
\coarse{\vslattice}  &\longrightarrow \vslattice \;, \\
\coarse{\psi}        &\longmapsto     \psi \;, \\
T \coarse{\psi} &= \sum_{i=0}^{N-1} \coarse{\psi}_{[i]} \phi_{i} \;. &
\end{aligned} \label{eq:T}
\end{align}

\tldr{projector definition}
The prolongator is related to the restrictor by Hermitian transposition $T = R^{\dagger}$.
Therefore, the restrictor is a $\coarse{d} \times d$ matrix, whereas the prolongator is a $d \times \coarse{d}$ matrix.
We can build the concatenation of the two and obtain the $d \times d$ Hermitian projector $P$, projecting spinor fields to the space along the $\phi_{i}$,
\begin{equation} \label{eq:P}
P = \prolongator \restrictor \colon \vslattice \longrightarrow \vslattice \;,
\qquad
P^{2} = P = P^{\dagger} \;.
\end{equation}

\section{Coarse operators}
\label{sec:sd:coarse:ops}

\tldr{coarse operator definition}
Next, we define operators on the subspace from operators acting on the lattice $\lattice$.
We consider such operators acting on the subspace as \df{coarsenings} of fine-grid operators.
For an operator on the lattice $K \colon \vslattice \longrightarrow \vslattice$, we define its coarse operator as
\begin{equation} \label{eq:sd:coarse:op}
\coarse{K} = \restrictor K \prolongator \colon \coarse{\vslattice} \longrightarrow \coarse{\vslattice} \;.
\end{equation}
In index notation, this is equivalent to
\begin{equation} \label{eq:coarse:index}
\coarse{K}_{[i j]} =
\sprod{ \phi_{i} }{ K \phi_{j} } =
\tr_{\idxset} \left( K \phi_j \phi_i^\dagger \right) \;,
% \sum_{x \in \idxspacetime}
% \sum_{\alpha \in \idxspin}
% \sum_{a \in \idxcolor}
%   \left( \fieldxaa{\phi_{i}}{x}{\alpha}{a} \right)^{\star}
%   \fieldxaa{\left(K \phi_{j}\right)}{x}{\alpha}{b} \;.
\end{equation}
where the trace goes over all spinor indices $\idxset = \idxspacetime \times \idxspin \times \idxcolor$.
The coarse operator may inherit certain properties of the fine-grid one, if the coarsening -- and by this the choice of the deflation basis $\mathcal{B}$ --  is done properly.
We will discuss these choices later.
A subset of indices may be left open, such as $\fieldx{\coarse{K}}{x}$ or $\fieldx{\coarse{K}}{x_0}$ indicating a partial trace in \cref{eq:coarse:index}.

\tldr{partial trace definition and open indices}
We define the \emph{partial trace} as follows.
Assuming two finite-dimensional Hilbert spaces, $\mathcal{H}_A$ and $\mathcal{H}_B$, we define the partial trace as the completely positive, trace preserving map (CPTPM) acting on the endomorphisms of the tensor product, yielding an endomorphism on the remaining Hilbert space,
\begin{align} \label{eq:partial:trace}
\begin{aligned}
\tr_B \colon \text{End}(\mathcal{H}_A \otimes \mathcal{H}_B) &\longrightarrow \text{End}(\mathcal{H}_A) \;, \\
O &\longmapsto \tr(O) = \sum_{i} ( \id_A \otimes \psi_i )^{\dagger} O ( \id_A \otimes \psi_i ) \;,
\end{aligned}
\end{align}
where $\{\psi_i\}_i$ is an orthonormal basis of $\mathcal{H}_B$ and $\id_A$ is the identity operator on $\mathcal{H}_A$.
When the subscript on the trace is absent, we implicitly trace out all degrees of freedom resulting in a number; $\tr \colon \text{End}(\mathcal{H}) \longrightarrow \mathbb{C}$.
Therefore, if in \cref{eq:coarse:index} the partial trace is taken, the index is absent in the trace on the right hand side.

\tldr{restriction and identity}
$\coarse{K}$ is the restriction of $K$ to the subspace spanned by the $\phi_{i} \in \mathcal{B}$.
As long as $N < 12V$, the coarse operator is smaller in dimension as depicted in \cref{fig:coarsen}.
\begin{figure}
  \includestandalone[width=0.6\linewidth]{\dir/img/coarsen}
  \caption{Depiction of the fact that the prolongator and restrictor are non-square matrices and coarse operator is a restriction of the fine-grid one by dimensional reduction.}
  \label{fig:coarsen}
\end{figure}
Trivially, when taking $K = \id$ we find the $\coarse{d} \times \coarse{d}$ identity on the subspace,
\begin{equation}
\coarse{\id} = \restrictor \prolongator \colon \coarse{\vslattice} \longrightarrow \coarse{\vslattice} \;.
\end{equation}

\section{Low-mode averaging}
\label{sec:sd:lma}

\tldr{LMA as specific choice of subspace deflation}
We can immediately see that low-mode averaging as introduced in \cref{ch:p2:lma} is a variant of subspace deflation with a particular choice for the fields spanning the subspace $\coarse{\vslattice}$ and the operator $K$ as
\begin{align}
K &= \gamma^{5} D \:.  &  &\text{ the Hermitian Dirac operator,} \\
\phi_i &= \evec_i \;,  &  &\text{ the $N=\cNc$ exact lowest modes of $Q$.}
\end{align}
%This choice makes the coarse Hermitian Dirac operator $\coarse{K}$ (as well as its inverse $\coarse{K}^{-1}$) diagonal with the eigenvalues $\lambda_i$ (and their reciprocal values respectively) along the diagonal.
We assume the eigenvalues of $K$ are enumerated in increasing order with respect to their magnitudes $\lvert \lambda_0 \rvert \leq \lvert \lambda_1 \rvert \leq \ldots \leq \lvert \lambda_{N-1} \rvert$.
The coarse Hermitian Dirac operator $\coarse{K}$ (as well as its inverse $\coarse{K}^{-1}$) are then diagonal matrices with the eigenvalues along their diagonals,
\begin{equation} \label{eq:sd:lma:diagonal:dirac}
\coarse{K} = \text{diag}\left(\lambda_0, \lambda_1, \ldots, \lambda_{N-1}\right) \;,
\qquad
\coarse{K}^{-1} = \text{diag}\left(\frac{1}{\lambda_0}, \frac{1}{\lambda_1}, \ldots, \frac{1}{\lambda_{N-1}}\right) \;.
\end{equation}
Furthermore, with the $\phi_i$ eigenmodes the projector commutes with the operator, $[P,Q]=0$, and thus the propagator $\prop$ decomposes exactly as in the LMA case
\begin{align}
\prop_{r} &= (1-P) \prop \;, \\
\prop_{e} &= PS = \prolongator \coarse{Q}^{-1} \restrictor \gamma^5 \;,
\end{align}
compare \cref{eq:prop:lma}.
This shows that $S_e$ is a low-rank approximation to $S$ in terms of its spectral decomposition with
\begin{equation}
\norm{S_e - S}_2
% = \norm{\sum_{i=N}^{12 V} \frac{1}{\lambda_i} \evec_i \evec_i^{d\dagger} }
 = \left\lvert \frac{1}{\lambda_{N}} \right\rvert \;,
\qquad
\rank(S_e) = N \;,
\end{equation}
where $\norm{\cdot}_2$ is the spectral norm.
This family of approximations conserves the low-mode behavior of the propagator which is responsible for the large distance behavior of the vector two-point correlator.
The rank of the approximation is the number of deflated low-modes $N$.
Although this parameter is under direct user control the memory requirements of LMA scale as $\bigO\left( N \right)$.

\section{Summary}
\label{sec:sd:summary}

\tldr{subspace deflation summary}
We have generalized the idea of low-mode averaging to deflation of an arbitrary subspace.
This led to a definition of linear operators restricted to that subspace which we refer to as coarsenings or coarse-grid operators.
%These dimensionally reduced operators are projected to the features of the subspace.
Such operators constitute a form of dimensional reduction via feature projection.
%Such operators need not be diagonal, as is the case for LMA.
%This chapter introduced the deflation of arbitrary subspaces specified by an orthonormal basis set of spinor fields.
To move data from the fine to the coarse subspace and vice versa, we specified inter-grid operators referred to as restrictor and prolongator.
We encountered that low-mode averaging is a special case of subspace deflation with a certain choice of basis making the coarse operator diagonal.

In the next chapter we introduce the decomposition of the lattice into blocks.
This will clarify why the Hilbert space $\coarse{\vslattice}$ was called ``coarse''.
%We will motivate why the Hilbert space $\coarse{\vslattice}$ is coined ``coarse'' in the next chapter.


